# Select文で指定したカラムの中から特定の値だけを抽出する

問題はこちら、greetingという列に数字だけが含まれているので、数字だけを抽出して、'userid'という列に出力してくださいというもの。

![image](https://user-images.githubusercontent.com/18514297/90948097-1a7e9a80-e476-11ea-95bb-55c96660d6db.png)

```
select
name,
greeting,
substr(substring(greeting,'#[0-9]+'),2) as user_id
from greetings
```

上記のコードで正解できた。覚えておきたいのは、指定したカラムの中から特定の値を抽出するのは、
substring関数を利用するということだ。

これとは別にselect文で抽出するレコード自体に対して、正規表現を条件に指定して、データを抽出したい場合、
Where句の条件文に対して、正規表現を適用することになる。

![image](https://user-images.githubusercontent.com/18514297/90946926-97a51200-e46c-11ea-97fc-c2c9357197c8.png)

https://www.jaswill.co.jp/blog/2011/09/30/postgresql/

あと、この問題、楽勝だと思ってたら、一癖あって、ポイントは以下の2点だった。

１．抽出したデータの2つの数値が含まれていること
これは単純に以下の条件で抽出すると、複数の数値に引っかかり、
条件に合致した最初の文字列だけが抽出される結果となってしまった。


```
substring(greeting,'[0-9]+',2) as user_id
```

お目当てのデータは2番目に存在しているため、検索条件を見直す必要があります。
そこで、検索条件に#までを含める形で以下のように条件を変更しました。

```
substring(greeting,'#[0-9]+',2) as user_id
```

ところが、こうすると別の問題が発生します。2.へ続く。

２．抽出したデータに#が含まれてしまう。

正解で示されている例は「数字」だけの形で、上記のクエリで抽出されるデータは「#数字」の形となってしまい、不正解となる。
そこで、抽出したデータ「#数字」を「数字」に変換する必要がある。
これが分からず、なかなか時間がかかった。

postgreの文字列取り出し関数は2種類あって、実はsubstringsとsubstrがあるんですが（分かりにくい）、
substr関数を親にして、子供にsubstring関数を指定し、substring関数で抽出したデータを
文字列の開始位置を指定してデータ取得するように処理を改良しました。

最終的に以下の形です。

```
substr(substring(greeting,'#[0-9]+'),2) as user_id
```

これは要は以下の処理を組み合わせて実施しているだけです。

```
substr(カラム,開始位置<省略すると先頭から>,終了位置<省略可能>)
substring(カラム,正規表現)
substr(substring(カラム,正規表現),開始位置を2番目に指定,<省略>)
```

妙なとこでハマって焦った。
